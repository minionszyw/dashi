<template>
  <view class="settings-page">
    <!-- AI对话设置 -->
    <view class="settings-section">
      <view class="section-title">AI对话设置</view>
      
      <view class="setting-item">
        <view class="item-header">
          <text class="item-label">上下文条数</text>
          <text class="item-value">{{ contextSize }} 条</text>
        </view>
        <view class="item-desc">设置AI记忆的对话轮数，越多消耗越大</view>
        <slider 
          class="slider"
          :value="contextSize" 
          :min="5" 
          :max="20" 
          :step="1"
          activeColor="#c9a87c"
          backgroundColor="#e8e6df"
          block-size="24"
          @changing="handleContextChanging"
          @change="handleContextChange"
        />
        <view class="slider-labels">
          <text>5条</text>
          <text>20条</text>
        </view>
      </view>
      
      <view class="setting-item">
        <view class="item-header">
          <text class="item-label">对话模式</text>
          <text class="item-value mode">{{ modeText }}</text>
        </view>
        <view class="item-desc">不同模式影响AI回答的详细程度</view>
        <view class="mode-options">
          <view 
            v-for="mode in modes" 
            :key="mode.value"
            class="mode-option"
            :class="{ active: aiStyle === mode.value }"
            @click="handleModeChange(mode.value)"
          >
            <view class="mode-icon">{{ mode.icon }}</view>
            <text class="mode-name">{{ mode.label }}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 保存按钮 -->
    <view class="save-section">
      <button class="save-button" @click="handleSave">
        <text>保存设置</text>
      </button>
    </view>
  </view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { useChatStore } from '@/stores'
import { storage } from '@/utils/storage'
import { updateConversation } from '@/api'

const chatStore = useChatStore()

const contextSize = ref(10)
const aiStyle = ref('balanced')

const modes = [
  { value: 'simple', label: '简单', icon: '📝', desc: '简明扼要，快速回答' },
  { value: 'balanced', label: '默认', icon: '⚖️', desc: '平衡专业性与易懂性' },
  { value: 'professional', label: '专业', icon: '🎓', desc: '详细专业，术语丰富' }
]

const modeText = computed(() => {
  return modes.find(m => m.value === aiStyle.value)?.label || '默认'
})

onMounted(() => {
  // 从当前会话或存储加载设置
  if (chatStore.currentConversation) {
    contextSize.value = chatStore.currentConversation.context_size || 10
    aiStyle.value = chatStore.currentConversation.ai_style || 'balanced'
  } else {
    // 从本地存储加载默认设置
    const savedSettings = storage.get<any>('ai_settings')
    if (savedSettings) {
      contextSize.value = savedSettings.contextSize || 10
      aiStyle.value = savedSettings.aiStyle || 'balanced'
    }
  }
})

function handleContextChanging(e: any) {
  // 拖动过程中实时更新显示
  contextSize.value = e.detail.value
}

function handleContextChange(e: any) {
  // 拖动结束后更新值
  contextSize.value = e.detail.value
}

function handleModeChange(mode: string) {
  aiStyle.value = mode
}

async function handleSave() {
  try {
    // 保存到本地存储作为默认设置
    storage.set('ai_settings', {
      contextSize: contextSize.value,
      aiStyle: aiStyle.value
    })
    
    // 如果有当前会话，更新会话设置
    if (chatStore.currentConversation) {
      const updated = await updateConversation(chatStore.currentConversation.id, {
        context_size: contextSize.value,
        ai_style: aiStyle.value
      })
      
      // 更新 store 中的会话数据
      chatStore.currentConversation = updated
      const index = chatStore.conversations.findIndex(c => c.id === updated.id)
      if (index !== -1) {
        chatStore.conversations[index] = updated
      }
    }
    
    uni.showToast({
      title: '保存成功',
      icon: 'success'
    })
    
    setTimeout(() => {
      uni.navigateBack()
    }, 1500)
  } catch (error: any) {
    uni.showToast({
      title: error.message || '保存失败',
      icon: 'none'
    })
  }
}
</script>

<style scoped lang="scss">
@import '@/styles/variables.scss';
@import '@/styles/mixins.scss';

.settings-page {
  min-height: 100vh;
  background: $bg-page;
  padding-bottom: $space-xxxl;
}

.settings-section {
  margin-top: $space-base;
  background: $bg-card;
  padding: $space-base;
}

.section-title {
  padding: $space-sm 0;
  font-size: $font-sm;
  color: $text-tertiary;
  font-weight: $weight-medium;
}

.setting-item {
  padding: $space-lg 0;
  border-bottom: 1rpx solid $border-color;
  
  &:last-child {
    border-bottom: none;
  }
}

.item-header {
  @include flex-between;
  margin-bottom: $space-sm;
}

.item-label {
  font-size: $font-lg;
  color: $text-primary;
  font-weight: $weight-semibold;
}

.item-value {
  font-size: $font-base;
  color: $primary;
  font-weight: $weight-medium;
  
  &.mode {
    color: $primary;
  }
}

.item-desc {
  font-size: $font-sm;
  color: $text-tertiary;
  line-height: 1.6;
  margin-bottom: $space-base;
}

.slider {
  width: 100%;
  margin: $space-lg 0 $space-sm;
}

.slider-labels {
  @include flex-between;
  font-size: $font-xs;
  color: $text-tertiary;
}

.mode-options {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: $space-base;
  margin-top: $space-base;
}

.mode-option {
  @include flex-center;
  flex-direction: column;
  padding: $space-lg;
  background: $bg-page;
  border-radius: $radius-lg;
  border: 3rpx solid transparent;
  transition: all $duration-fast $ease-in-out;
  
  &.active {
    background: rgba($primary, 0.1);
    border-color: $primary;
  }
  
  &:active {
    transform: scale(0.95);
  }
}

.mode-icon {
  font-size: 48rpx;
  margin-bottom: $space-sm;
}

.mode-name {
  font-size: $font-base;
  color: $text-primary;
  font-weight: $weight-medium;
}

.save-section {
  padding: $space-xxl $space-base;
}

.save-button {
  @include btn-primary;
  height: 88rpx;
  font-size: $font-lg;
}
</style>

